name: Check Breaking Changes

on: [workflow_dispatch]

env:
  HELM_REPO_NAME: operator
  HELM_REPO_URL: https://hazelcast-charts.s3.amazonaws.com
  
jobs:
  check_breaking_changes:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - uses: actions/setup-go@v5
      with:
        go-version: "1.22.3"    

    - name: Run check for breaking changes
      working-directory: tools/version-diff-tool
      run: |
        helm repo add hazelcast https://hazelcast-charts.s3.amazonaws.com && helm repo update && \
        STABLE_VERSION=$(curl -s https://artifacthub.io/api/v1/packages/helm/hazelcast/hazelcast-platform-operator | jq -r '.available_versions | map(select(.version | contains("snapshot") | not)) | .[0].version')
        LATEST_SNAPSHOT=$(curl -s https://artifacthub.io/api/v1/packages/helm/hazelcast/hazelcast-platform-operator | jq -r '.version')
          
        OUTPUT=$(go run main.go -base $LATEST_STABLE_VERSION -revision $LATEST_SNAPSHOT)

        # Check for "0 breaking changes"
        if echo "$OUTPUT" | grep -q "0 breaking changes"; then
          echo "No breaking changes found."
        else
          echo "$OUTPUT"
          exit 1
        fi
